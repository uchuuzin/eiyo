<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜æ—¥ãƒˆãƒ¬ï¼æ „é¤Šãƒã‚§ãƒƒã‚¯ v8.0 (ãƒ­ãƒ¼ã‚«ãƒ«ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
        .card { box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); }
        .pfc-indicator { transition: all 0.5s ease-in-out; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-4xl mx-auto">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">æ˜æ—¥ãƒˆãƒ¬ï¼æ „é¤Šãƒã‚§ãƒƒã‚¯ v8.0</h1>
            <p id="user-id-display" class="text-sm text-gray-500 mt-1">UserID: ãƒ‡ãƒ¢ç‰ˆ (ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜)</p>
        </header>

        <!-- ãƒ¡ã‚¤ãƒ³ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- å·¦å´: æ „é¤Šè¨˜éŒ²ã¨ç›®æ¨™ -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- ç›®æ¨™ã¨PFCæ¦‚è¦ -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-2xl font-bold mb-4 text-gray-700 flex justify-between items-center">
                        ä»Šæ—¥ã®ç›®æ¨™ã¨é€²æ—
                        <span id="overall-face" class="text-4xl">ğŸ¤”</span>
                    </h2>
                    
                    <div id="target-summary" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <!-- ç›®æ¨™PFCã¯JSã§æŒ¿å…¥ -->
                    </div>

                    <div id="pfc-visualization" class="mt-6 space-y-3">
                        <!-- æ „é¤Šç´ ã®é€²æ—ãƒãƒ¼ã¯JSã§æŒ¿å…¥ -->
                    </div>
                </div>

                <!-- é£Ÿäº‹ãƒ»é‹å‹•å…¥åŠ› (æ‰‹å‹•å…¥åŠ›æ©Ÿèƒ½ã‚’è¿½åŠ ) -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-xl font-bold mb-3 text-gray-700">é£Ÿäº‹ãƒ»é‹å‹•ã‚’è¨˜éŒ²</h2>
                    
                    <!-- 1. AIè‡ªå‹•è§£æ (æ—¢å­˜) -->
                    <div class="mb-6 border-b pb-4 border-gray-200">
                        <h3 class="font-semibold text-base mb-2 text-gray-600">â‘  AIè‡ªå‹•è§£æ (é£Ÿäº‹ãƒ»é‹å‹•ã‚’è‡ªç”±ã«å…¥åŠ›)</h3>
                        <div class="flex flex-col md:flex-row gap-2">
                            <input type="text" id="log-input" placeholder="ä¾‹: é¶ã‚€ã­è‚‰ 150g, ã”é£¯ 200g, ãƒ©ãƒ³ãƒ‹ãƒ³ã‚° 30åˆ†" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                            <button id="submit-log" class="bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150 whitespace-nowrap">AIã«è¨˜éŒ²ã•ã›ã‚‹</button>
                        </div>
                        <p id="log-status" class="text-sm mt-2 text-gray-500"></p>
                    </div>

                    <!-- 2. PFCæ‰‹å‹•å…¥åŠ› (æ–°è¦è¿½åŠ  - å¾©æ´») -->
                    <div>
                        <h3 class="font-semibold text-base mb-2 text-gray-600">â‘¡ PFCæ‰‹å‹•å…¥åŠ› (ã‚µãƒ—ãƒªã‚„æ¸¬å®šå€¤ãªã©)</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-2 mb-3">
                            <input type="number" id="manual-p" placeholder="P (g)" class="p-3 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="manual-f" placeholder="F (g)" class="p-3 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="manual-c" placeholder="C (g)" class="p-3 border border-gray-300 rounded-lg text-center">
                            <input type="number" id="manual-kcal" placeholder="Kcal" class="p-3 border border-gray-300 rounded-lg text-center">
                        </div>
                        <div class="flex gap-2">
                            <input type="text" id="manual-description" placeholder="èª¬æ˜ (ä¾‹: ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã‚·ã‚§ã‚¤ã‚¯ã€é‹å‹•: -400)" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500">
                            <button id="submit-manual-log" class="bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 transition duration-150 whitespace-nowrap">æ‰‹å‹•è¨˜éŒ²</button>
                        </div>
                        <p id="manual-log-status" class="text-sm mt-2 text-gray-500"></p>
                    </div>
                </div>

                <!-- ãƒ­ã‚°å±¥æ­´ -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">ä»Šæ—¥ã®è¨˜éŒ² (<span id="log-date"></span>)</h2>
                    <div id="daily-log-entries" class="space-y-4">
                        <p class="text-gray-500" id="no-log-message">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
                        <!-- ãƒ­ã‚°ã¯ã“ã“ã«æŒ¿å…¥ -->
                    </div>
                </div>
            </div>

            <!-- å³å´: AIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
            <div class="lg:col-span-1 space-y-6">
                
                <!-- AIæ „é¤Šå£«ãƒãƒ£ãƒƒãƒˆ -->
                <div class="card bg-gray-50 p-6 rounded-xl border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-blue-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2m-3 14v2m-6-2v2M5 10v4h14v-4H5zM10 5v14m4-14v14m-9-3h18"/>
                        </svg>
                        AIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ (Gemini)
                    </h2>
                    
                    <div id="chat-output" class="h-56 overflow-y-auto bg-white p-3 rounded-lg border border-gray-300 mb-3 space-y-3 text-sm">
                        <div class="text-gray-500">ã“ã‚“ã«ã¡ã¯ï¼ä»Šæ—¥ã®æ „é¤Šã‚„ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®ç›®æ¨™ã«ã¤ã„ã¦ä½•ã§ã‚‚èã„ã¦ãã ã•ã„ã€‚</div>
                    </div>

                    <div class="flex gap-2">
                        <input type="text" id="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ› (ä¾‹: ãŠã™ã™ã‚ã®ãƒ—ãƒ­ãƒ†ã‚¤ãƒ³ã¯?)" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                        <button id="send-chat" class="bg-indigo-500 text-white p-2 rounded-lg font-semibold hover:bg-indigo-600 transition duration-150">é€ä¿¡</button>
                    </div>
                </div>

                <!-- AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
                <div class="card bg-white p-6 rounded-xl border border-gray-200">
                    <h2 class="text-xl font-bold mb-4 text-gray-700">AIã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
                    <div id="ai-feedback" class="text-gray-600 space-y-3 text-sm">
                        <p id="p-score-feedback" class="font-semibold text-orange-500">ã‚¿ãƒ³ãƒ‘ã‚¯è³ªã‚¹ã‚³ã‚¢: ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ã¨ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚</p>
                        <p id="next-day-advice">æ˜æ—¥ã¸ã®æˆ¦ç•¥ï¼šAIãŒæ—¥ã€…ã®è¨˜éŒ²ã‹ã‚‰æœ€é©ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›ã—ã¾ã™ã€‚</p>
                    </div>
                </div>

            </div>
        </div>

    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ã¨ã—ã¦åˆ©ç”¨ï¼‰ -->
    <div id="modal" class="hidden fixed inset-0 bg-gray-800 bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <button id="modal-close" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 transition duration-150">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="text/javascript">
        // ğŸš¨ ã€AIæ©Ÿèƒ½ã®ãŸã‚ã«ä¿®æ­£å¿…é ˆã€‘
        // ----------------------------------------------------------------------------------
        // AIæ©Ÿèƒ½ï¼ˆGeminiï¼‰ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã®APIã‚­ãƒ¼ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚
        // ã“ã‚Œã¯Google AI Studioï¼ˆGoogle AI for Developersï¼‰ã§å–å¾—ã—ãŸå°‚ç”¨ã‚­ãƒ¼ã‚’æ¨å¥¨ã—ã¾ã™ã€‚
        // ä¾‹: const GEMINI_API_KEY = 'AIzaSyXXXXXXXXXXXXXXXXXX';
        const GEMINI_API_KEY = 'AIzaSyBtpm-Khdd6kKQKzCoSFXI2FsTPMy6ZUcM'; // â† ã€é‡è¦ã€‘ã“ã“ã«å›ã®APIã‚­ãƒ¼ã‚’è²¼ã‚Šä»˜ã‘ã‚‹ï¼
        // ----------------------------------------------------------------------------------

        // Global Variables (Firebaseé–¢é€£ã¯å‰Šé™¤)
        let userId = 'Demo-User-Local'; // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç‰ˆã®ãƒ‡ãƒ¢ID
        let currentLogData = null; // ä»Šæ—¥ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿
        let currentTargets = null; // ç›®æ¨™ãƒ‡ãƒ¼ã‚¿

        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=";

        // UI Elements
        const logInput = document.getElementById('log-input');
        const submitLogButton = document.getElementById('submit-log');
        const dailyLogEntries = document.getElementById('daily-log-entries');
        const logStatus = document.getElementById('log-status');
        const targetSummary = document.getElementById('target-summary');
        const pfcVisualization = document.getElementById('pfc-visualization');
        const overallFace = document.getElementById('overall-face');
        const chatInput = document.getElementById('chat-input');
        const sendChatButton = document.getElementById('send-chat');
        const chatOutput = document.getElementById('chat-output');
        const modal = document.getElementById('modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalClose = document.getElementById('modal-close');
        const pScoreFeedback = document.getElementById('p-score-feedback');
        const nextDayAdvice = document.getElementById('next-day-advice');
        const userIdDisplay = document.getElementById('user-id-display');
        const noLogMessage = document.getElementById('no-log-message');

        // ã€æ–°è¦è¿½åŠ ã•ã‚ŒãŸUIè¦ç´ ã€‘
        const manualP = document.getElementById('manual-p');
        const manualF = document.getElementById('manual-f');
        const manualC = document.getElementById('manual-c');
        const manualKcal = document.getElementById('manual-kcal');
        const manualDescription = document.getElementById('manual-description');
        const submitManualLogButton = document.getElementById('submit-manual-log');
        const manualLogStatus = document.getElementById('manual-log-status');


        // Helper Functions
        const todayKey = () => new Date().toISOString().slice(0, 10); // YYYY-MM-DD
        
        function showModal(title, message) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modal.classList.remove('hidden');
        }

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        function formatPFC(grams) {
            return grams.toFixed(0) + 'g';
        }

        function formatKcal(kcal) {
            return kcal.toFixed(0) + 'kcal';
        }

        // --- Local Storage Core Logic ---

        function loadTargetsAndLogsFromLocal() {
            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ‰
            const targetsJson = localStorage.getItem('nutrition_targets');
            if (targetsJson) {
                currentTargets = JSON.parse(targetsJson);
            } else {
                // åˆæœŸç›®æ¨™å€¤ã®è¨­å®šã¨ä¿å­˜
                currentTargets = {
                    protein: 150, fat: 60, carbs: 300, kcal: 2500, isInitialized: true 
                };
                localStorage.setItem('nutrition_targets', JSON.stringify(currentTargets));
            }
            
            // ä»Šæ—¥ã®ãƒ­ã‚°ã®ãƒ­ãƒ¼ãƒ‰
            const logJson = localStorage.getItem(`daily_logs_${todayKey()}`);
            if (logJson) {
                currentLogData = JSON.parse(logJson);
            } else {
                currentLogData = {
                    logs: [], P: 0, F: 0, C: 0, Kcal: 0, netKcal: 0, exerciseKcal: 0
                };
            }
            
            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã®ãƒ­ãƒ¼ãƒ‰
            const historyJson = localStorage.getItem('chat_history');
            const history = historyJson ? JSON.parse(historyJson) : [];
            renderChatHistory(history);

            // UIã®å†æç”»
            renderAllUI();
        }

        async function saveLogToLocal(updatedLog) {
            localStorage.setItem(`daily_logs_${todayKey()}`, JSON.stringify(updatedLog));
            currentLogData = updatedLog; // å³åº§ã«åæ˜ 
            renderAllUI();
        }

        function fetchChatHistoryFromLocal() {
             const historyJson = localStorage.getItem('chat_history');
             return historyJson ? JSON.parse(historyJson) : [];
        }

        async function saveChatHistoryToLocal(history) {
            localStorage.setItem('chat_history', JSON.stringify(history));
        }

        // --- AI Schema Definitions (å¤‰æ›´ãªã—) ---
        const NUTRITION_SCHEMA = {
            type: "OBJECT",
            properties: {
                totalProtein: { type: "NUMBER", description: "ç·ã‚¿ãƒ³ãƒ‘ã‚¯è³ª (g)" },
                totalFat: { type: "NUMBER", description: "ç·è„‚è³ª (g)" },
                totalCarbs: { type: "NUMBER", description: "ç·ç‚­æ°´åŒ–ç‰© (g)" },
                totalCalories: { type: "NUMBER", description: "ç·ã‚«ãƒ­ãƒªãƒ¼ (kcal)" },
                items: {
                    type: "ARRAY",
                    description: "è§£æã•ã‚ŒãŸé£Ÿäº‹ãƒ»é‹å‹•ã‚¢ã‚¤ãƒ†ãƒ ã®é…åˆ—",
                    items: {
                        type: "OBJECT",
                        properties: {
                            type: { type: "STRING", enum: ["meal", "exercise"], description: "ã‚¢ã‚¤ãƒ†ãƒ ã®ã‚¿ã‚¤ãƒ—" },
                            description: { type: "STRING", description: "è§£æã•ã‚ŒãŸã‚¢ã‚¤ãƒ†ãƒ ã®èª¬æ˜" },
                            protein: { type: "NUMBER", description: "ã‚¿ãƒ³ãƒ‘ã‚¯è³ª (g) (é‹å‹•ã®å ´åˆã¯0)" },
                            fat: { type: "NUMBER", description: "è„‚è³ª (g) (é‹å‹•ã®å ´åˆã¯0)" },
                            carbs: { type: "NUMBER", description: "ç‚­æ°´åŒ–ç‰© (g) (é‹å‹•ã®å ´åˆã¯0)" },
                            calories: { type: "NUMBER", description: "ã‚«ãƒ­ãƒªãƒ¼ (kcal) (é‹å‹•ã®å ´åˆã¯æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã¨ã—ã¦ãƒã‚¤ãƒŠã‚¹å€¤)" },
                        },
                        required: ["type", "description", "protein", "fat", "carbs", "calories"]
                    }
                }
            }
        };

        const FEEDBACK_SCHEMA = {
            type: "OBJECT",
            properties: {
                pfcScore: { 
                    type: "STRING", 
                    description: "PFCã®é”æˆåº¦ã«åŸºã¥ãé¡”æ–‡å­—è©•ä¾¡ã€‚ä¾‹: 'ğŸ˜', 'ğŸ˜', 'ğŸ˜«'" 
                },
                proteinScoreFeedback: { 
                    type: "STRING", 
                    description: "ã‚¿ãƒ³ãƒ‘ã‚¯è³ªæ‘‚å–é‡ã«åŸºã¥ãå…·ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã€‚" 
                },
                nextDayAdvice: { 
                    type: "STRING", 
                    description: "ç¿Œæ—¥ã®é£Ÿäº‹æˆ¦ç•¥ã«é–¢ã™ã‚‹å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã€‚" 
                }
            }
        };

        // --- Core Application Logic (Firebaseä¾å­˜éƒ¨åˆ†ã‚’å‰Šé™¤) ---

        /**
         * AI APIå‘¼ã³å‡ºã— (Exponential Backoffå®Ÿè£…)
         */
        async function fetchAI(url, payload) {
            if (!GEMINI_API_KEY) {
                throw new Error("APIã‚­ãƒ¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            }
            
            for (let attempt = 0; attempt < 5; attempt++) {
                try {
                    const fullUrl = `${url}${GEMINI_API_KEY}`;
                    const response = await fetch(fullUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        console.error(`Attempt ${attempt + 1}: AI API HTTP Error: ${response.status} - ${errorBody}`);
                        if (response.status === 429 || response.status >= 500) {
                            if (attempt < 4) {
                                const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                                await new Promise(resolve => setTimeout(resolve, delay));
                                continue;
                            } else {
                                throw new Error("AI APIå‘¼ã³å‡ºã—ãŒ5å›å¤±æ•—ã—ã¾ã—ãŸã€‚");
                            }
                        } else {
                            throw new Error(`AI API Client Error: ${response.status}`);
                        }
                    }

                    const result = await response.json();
                    const jsonText = result.candidates?.[0]?.content?.parts?.[0]?.text;

                    if (!jsonText) throw new Error("AIå¿œç­”ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");

                    if (payload.generationConfig && payload.generationConfig.responseMimeType === "application/json") {
                        return JSON.parse(jsonText);
                    } else {
                        return jsonText; 
                    }

                } catch (error) {
                    if (error.message.includes("failed to fetch") || error.message.includes("network error")) {
                        if (attempt < 4) {
                            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            continue;
                        }
                    }
                    throw error;
                }
            }
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ã‹ã‚‰æ „é¤Šç´ ã‚’æŠ½å‡ºãƒ»è¨ˆç®—ã™ã‚‹
         */
        async function analyzeNutrition(prompt) {
            // ... (ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            const systemPrompt = `ã‚ãªãŸã¯ä¸–ç•Œæœ€é«˜ã®æ „é¤Šè¨ˆç®—AIã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å…¥åŠ› (é£Ÿäº‹ã‚„é‹å‹•) ã‹ã‚‰ã€ç·PFCã¨ç·ã‚«ãƒ­ãƒªãƒ¼ã‚’è¨ˆç®—ã—ã€JSONå½¢å¼ã§è¿”ã—ã¾ã™ã€‚
                é£Ÿäº‹ã¯ãƒ—ãƒ©ã‚¹ã®ã‚«ãƒ­ãƒªãƒ¼ã€é‹å‹•ã¯ãƒã‚¤ãƒŠã‚¹ã®ã‚«ãƒ­ãƒªãƒ¼ã¨ã—ã¦è¨ˆç®—ã—ã¦ãã ã•ã„ã€‚
                PFCã®è¨ˆç®—ã¯ã€é£Ÿå“ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚„ä¸€èˆ¬çš„ãªæ „é¤Šå­¦ã«åŸºã¥ã„ã¦ã€æ­£ç¢ºã«è¡Œã£ã¦ãã ã•ã„ã€‚
                å¿…ãšitemsé…åˆ—ã‚’å«ã‚ã€å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ 'meal' ã¾ãŸã¯ 'exercise' ã®ã‚¿ã‚¤ãƒ—ã«åˆ†é¡ã—ã€PFC/ã‚«ãƒ­ãƒªãƒ¼ã‚’å…·ä½“çš„ã«è¨ˆç®—ã—ã¦å«ã‚ã¦ãã ã•ã„ã€‚
                ã‚«ãƒ­ãƒªãƒ¼ã¯å››æ¨äº”å…¥ã—ã¦æ•´æ•°ã«ã—ã¦ãã ã•ã„ã€‚
                ä¾‹: 'é¶ã‚€ã­è‚‰150g, ã”é£¯200g, ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°30åˆ†' -> 
                { totalProtein: 54, totalFat: 4, totalCarbs: 72, totalCalories: 532, items: [...] }`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: NUTRITION_SCHEMA
                },
                tools: [{ "google_search": {} }] 
            };

            return fetchAI(API_URL, payload);
        }

        /**
         * ãƒ­ã‚°è¨˜éŒ²ãƒœã‚¿ãƒ³ã®å‡¦ç† (AIè§£æ)
         */
        submitLogButton.addEventListener('click', async () => {
            if (!currentTargets) {
                showModal("å‡¦ç†å¾…æ©Ÿä¸­", "åˆæœŸè¨­å®šãŒå®Œäº†ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                return;
            }

            const input = logInput.value.trim();
            if (input === '') {
                showModal("å…¥åŠ›ãŒå¿…è¦ã§ã™", "é£Ÿäº‹å†…å®¹ã‹é‹å‹•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            submitLogButton.disabled = true;
            logStatus.textContent = 'AIãŒæ „é¤Šç´ ã‚’è¨ˆç®—ä¸­... ğŸƒâ€â™‚ï¸ğŸ½ï¸';

            try {
                const analysisResult = await analyzeNutrition(input);
                
                if (!analysisResult) throw new Error("AIè§£æçµæœãŒç©ºã§ã—ãŸã€‚");

                const newLog = {
                    time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                    input: input,
                    ...analysisResult,
                    items: analysisResult.items || [] 
                };

                // æ—¢å­˜ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã«åŠ ç®—
                const updatedLog = {
                    logs: [...currentLogData.logs, newLog],
                    P: currentLogData.P + (analysisResult.totalProtein || 0),
                    F: currentLogData.F + (analysisResult.totalFat || 0),
                    C: currentLogData.C + (analysisResult.totalCarbs || 0),
                    Kcal: currentLogData.Kcal + (analysisResult.totalCalories || 0),
                    exerciseKcal: currentLogData.exerciseKcal + (analysisResult.items.filter(i => i.type === 'exercise').reduce((sum, item) => sum + Math.abs(item.calories), 0)),
                    netKcal: currentLogData.Kcal + currentLogData.exerciseKcal + (analysisResult.totalCalories || 0)
                };

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
                await saveLogToLocal(updatedLog);

                logInput.value = '';
                logStatus.textContent = 'è¨˜éŒ²å®Œäº†ï¼ (ãƒ‡ãƒ¼ã‚¿ã¯ãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ)';

                // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éåŒæœŸã§å®Ÿè¡Œ
                fetchFeedback(updatedLog);

            } catch (error) {
                console.error("Log Submission Error:", error);
                logStatus.textContent = 'è¨˜éŒ²ã«å¤±æ•—ã—ã¾ã—ãŸã€‚AIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
                showModal("è¨˜éŒ²ã‚¨ãƒ©ãƒ¼", "æ „é¤Šè¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚AIã‚­ãƒ¼ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
            } finally {
                submitLogButton.disabled = false;
            }
        });

        /**
         * ãƒ­ã‚°è¨˜éŒ²ãƒœã‚¿ãƒ³ã®å‡¦ç† (æ‰‹å‹•å…¥åŠ›)
         */
        submitManualLogButton.addEventListener('click', async () => {
            if (!currentTargets) {
                showModal("å‡¦ç†å¾…æ©Ÿä¸­", "åˆæœŸè¨­å®šãŒå®Œäº†ã™ã‚‹ã¾ã§ãŠå¾…ã¡ãã ã•ã„ã€‚");
                return;
            }

            const P = parseFloat(manualP.value) || 0;
            const F = parseFloat(manualF.value) || 0;
            const C = parseFloat(manualC.value) || 0;
            const Kcal = parseFloat(manualKcal.value) || 0;
            const description = manualDescription.value.trim() || 'æ‰‹å‹•å…¥åŠ›';

            if (P === 0 && F === 0 && C === 0 && Kcal === 0) {
                showModal("å…¥åŠ›ãŒå¿…è¦ã§ã™", "PFCã¾ãŸã¯ã‚«ãƒ­ãƒªãƒ¼ã®å€¤ã‚’1ã¤ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                return;
            }

            submitManualLogButton.disabled = true;
            manualLogStatus.textContent = 'æ‰‹å‹•ã§è¨˜éŒ²ä¸­...';

            try {
                const newLog = {
                    time: new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }),
                    input: `(æ‰‹å‹•) ${description} P${P} F${F} C${C} Kcal${Kcal}`,
                    totalProtein: P,
                    totalFat: F,
                    totalCarbs: C,
                    totalCalories: Kcal,
                    items: [{
                        // ã‚«ãƒ­ãƒªãƒ¼ãŒè² ã®å€¤ï¼ˆKcal < 0ï¼‰ã§ã‚ã‚Œã°é‹å‹•ã¨ã—ã¦æ‰±ã†
                        type: Kcal < 0 ? 'exercise' : 'meal', 
                        description: description, 
                        protein: P, 
                        fat: F, 
                        carbs: C, 
                        calories: Kcal
                    }]
                };

                // æ—¢å­˜ã®ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã«åŠ ç®—
                const updatedLog = {
                    logs: [...currentLogData.logs, newLog],
                    P: currentLogData.P + P,
                    F: currentLogData.F + F,
                    C: currentLogData.C + C,
                    Kcal: currentLogData.Kcal + Kcal,
                    // ãƒã‚¤ãƒŠã‚¹å€¤ã®å ´åˆã®ã¿æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã¨ã—ã¦åŠ ç®— (abs(Kcal))
                    exerciseKcal: currentLogData.exerciseKcal + (Kcal < 0 ? Math.abs(Kcal) : 0),
                    netKcal: currentLogData.Kcal + currentLogData.exerciseKcal + Kcal
                };

                await saveLogToLocal(updatedLog);

                // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
                manualP.value = manualF.value = manualC.value = manualKcal.value = manualDescription.value = '';
                manualLogStatus.textContent = 'æ‰‹å‹•è¨˜éŒ²å®Œäº†ï¼';

                // AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’éåŒæœŸã§å®Ÿè¡Œ
                fetchFeedback(updatedLog);

            } catch (error) {
                console.error("Manual Log Submission Error:", error);
                manualLogStatus.textContent = 'æ‰‹å‹•è¨˜éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                showModal("è¨˜éŒ²ã‚¨ãƒ©ãƒ¼", "æ‰‹å‹•ã§ã®è¨˜éŒ²å‡¦ç†ä¸­ã«äºˆæœŸã›ã¬ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
            } finally {
                submitManualLogButton.disabled = false;
            }
        });


        /**
         * ãƒ­ã‚°ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰AIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ç”Ÿæˆã—ã€UIã«åæ˜ ã™ã‚‹
         */
        async function fetchFeedback(logData) {
            // ... (ãƒ­ã‚¸ãƒƒã‚¯ã¯å¤‰æ›´ãªã—)
            const systemPrompt = `ã‚ãªãŸã¯å°‚é–€ã®AIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ã™ã€‚ä»¥ä¸‹ã®JSONã‚¹ã‚­ãƒ¼ãƒã«å¾“ã£ã¦ã€ä»Šæ—¥ã®PFCé”æˆåº¦ã€ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°å†…å®¹ã€ãŠã‚ˆã³ç›®æ¨™(${JSON.stringify(currentTargets)})ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¨ç¿Œæ—¥ã®æˆ¦ç•¥ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

            const prompt = `ä»Šæ—¥ã®ãƒ­ã‚°: ${JSON.stringify(logData)}ã€‚\nç¾åœ¨ã®ç›®æ¨™: P${currentTargets.protein}g, F${currentTargets.fat}g, C${currentTargets.carbs}g, Kcal${currentTargets.kcal}kcalã€‚ã“ã‚Œã«åŸºã¥ãã€é”æˆåº¦ã‚’è©•ä¾¡ã—ã€å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã¨ç¿Œæ—¥ã®æˆ¦ç•¥ã‚’ç”Ÿæˆã—ã¦ãã ã•ã„ã€‚`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: FEEDBACK_SCHEMA
                }
            };

            try {
                const feedbackResult = await fetchAI(API_URL, payload);
                if (feedbackResult) {
                    overallFace.textContent = feedbackResult.pfcScore || 'ğŸ¤”';
                    pScoreFeedback.innerHTML = `**${feedbackResult.pfcScore}** ${feedbackResult.proteinScoreFeedback || 'è©•ä¾¡ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'}`;
                    nextDayAdvice.innerHTML = `**æ¬¡ã®ä¸€æ‰‹:** ${feedbackResult.nextDayAdvice || 'ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã§ã—ãŸã€‚'}`;
                }
            } catch (error) {
                console.error("Feedback Generation Error:", error);
                overallFace.textContent = 'ã‚¨ãƒ©ãƒ¼';
                pScoreFeedback.textContent = 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ç”Ÿæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
            }
        }
        
        /**
         * ãƒãƒ£ãƒƒãƒˆUIã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã™ã‚‹
         */
        function renderChatHistory(history) {
            chatOutput.innerHTML = '';
            history.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = msg.role === 'user' ? 
                    'text-right p-2 bg-blue-100 rounded-lg max-w-xs ml-auto' : 
                    'text-left p-2 bg-gray-200 rounded-lg max-w-xs mr-auto';
                messageDiv.innerHTML = `<strong>${msg.role === 'user' ? 'You' : 'AI'}:</strong> ${msg.text}`;
                chatOutput.appendChild(messageDiv);
            });
            chatOutput.scrollTop = chatOutput.scrollHeight;
        }

        /**
         * ãƒãƒ£ãƒƒãƒˆé€ä¿¡ãƒœã‚¿ãƒ³ã®å‡¦ç†
         */
        sendChatButton.addEventListener('click', async () => {
            const prompt = chatInput.value.trim();
            if (prompt === '') return;

            // å±¥æ­´ã«è¿½åŠ  (ãƒ¦ãƒ¼ã‚¶ãƒ¼)
            let currentHistory = fetchChatHistoryFromLocal();
            currentHistory.push({ role: 'user', text: prompt });
            renderChatHistory(currentHistory);
            chatInput.value = '';
            sendChatButton.disabled = true;

            const systemPrompt = "ã‚ãªãŸã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ „é¤Šã¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã®è³ªå•ã«ç­”ãˆã‚‹ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼ãªAIãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è³ªå•ã«ã¯ã€Googleæ¤œç´¢æ©Ÿèƒ½ã‚’ä½¿ã£ã¦æœ€æ–°ã®æƒ…å ±ã«åŸºã¥ã„ã¦ã€ç°¡æ½”ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
                tools: [{ "google_search": {} }]
            };

            try {
                const result = await fetchAI(API_URL, payload);

                // å±¥æ­´ã«è¿½åŠ  (AI)
                currentHistory.push({ role: 'ai', text: result });
                saveChatHistoryToLocal(currentHistory); // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜

            } catch (error) {
                console.error("Chat API Error:", error);
                let currentHistory = fetchChatHistoryFromLocal(); // ã‚¨ãƒ©ãƒ¼æ™‚ã«å†å–å¾—
                currentHistory.push({ role: 'ai', text: 'ã”ã‚ã‚“ãªã•ã„ã€AIã¨ã®é€šä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚APIã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚' });
                saveChatHistoryToLocal(currentHistory); 
            } finally {
                sendChatButton.disabled = false;
            }
        });
        
        // --- UI Rendering (å¤‰æ›´ãªã—) ---
        function renderAllUI() {
            if (!currentTargets || !currentLogData) { return; }
            renderDailyLogs();
            renderTargetSummary();
            renderPFCVisualization();
            
            const baseKcalTarget = currentTargets.kcal || 2500;
            const netKcalTarget = baseKcalTarget + currentLogData.exerciseKcal;
            
            const kcalPercentage = currentLogData.Kcal / netKcalTarget;
            const pfcPercentage = [
                currentLogData.P / currentTargets.protein,
                currentLogData.F / currentTargets.fat,
                currentLogData.C / currentTargets.carbs
            ].filter(p => p > 0).reduce((a, b) => a + b, 0) / 3;

            let faceIcon = 'ğŸ¤”';
            if (kcalPercentage > 0.9 && kcalPercentage < 1.1 && pfcPercentage > 0.8) {
                faceIcon = 'ğŸ˜';
            } else if (kcalPercentage > 1.2 || kcalPercentage < 0.8) {
                faceIcon = 'ğŸ˜«';
            } else if (kcalPercentage > 0.8 && pfcPercentage > 0.5) {
                faceIcon = 'ğŸ˜';
            }
            overallFace.textContent = faceIcon;
        }

        function renderDailyLogs() {
            dailyLogEntries.innerHTML = '';
            document.getElementById('log-date').textContent = todayKey();

            if (currentLogData.logs.length === 0) {
                noLogMessage.classList.remove('hidden');
                return;
            } else {
                noLogMessage.classList.add('hidden');
            }

            currentLogData.logs.slice().reverse().forEach((log) => {
                const isExercise = log.items.some(item => item.type === 'exercise');
                const logType = isExercise ? 'é‹å‹•' : 'é£Ÿäº‹';
                const bgColor = isExercise ? 'bg-green-50' : 'bg-blue-50';
                const icon = isExercise ? 'ğŸƒâ€â™‚ï¸' : 'ğŸ½ï¸';

                const detailText = log.items.map(item => {
                    const cals = item.calories !== 0 ? `(${formatKcal(item.calories)})` : '';
                    if (item.type === 'meal') {
                        return `${item.description}: P${formatPFC(item.protein)} F${formatPFC(item.fat)} C${formatPFC(item.carbs)}`;
                    } else {
                        // é‹å‹•ã®å ´åˆã€æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã¨ã—ã¦è¡¨ç¤º
                        return `${item.description}: æ¶ˆè²»${formatKcal(Math.abs(item.calories))}`;
                    }
                }).join(' / ');
                
                // ãƒ¡ã‚¤ãƒ³ã®è¡¨ç¤ºå†…å®¹ã‚’èª¿æ•´: æ‰‹å‹•å…¥åŠ›ã®å ´åˆã€inputã‚’ãã®ã¾ã¾è¡¨ç¤º
                const displayText = log.input.startsWith('(æ‰‹å‹•)') ? log.input.replace('(æ‰‹å‹•) ', '') : log.input;


                const logElement = document.createElement('div');
                logElement.className = `${bgColor} p-3 rounded-lg flex justify-between items-center transition duration-150 hover:shadow-md`;
                logElement.innerHTML = `
                    <div class="flex-grow">
                        <span class="font-bold text-gray-800">${icon} ${log.time} (${logType})</span>
                        <p class="text-xs text-gray-600 mt-1">${displayText}</p>
                    </div>
                    <div class="text-right">
                        <span class="text-sm font-semibold text-gray-700">${formatKcal(log.totalCalories)}</span>
                        <p class="text-xs text-gray-500">${detailText}</p>
                    </div>
                `;
                dailyLogEntries.appendChild(logElement);
            });
        }

        function renderTargetSummary() {
            targetSummary.innerHTML = '';
            
            const baseKcalTarget = currentTargets.kcal || 2500;
            const netKcalTarget = baseKcalTarget + currentLogData.exerciseKcal;
            
            const stats = [
                { label: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª', unit: 'g', target: currentTargets.protein, current: currentLogData.P, color: 'blue' },
                { label: 'è„‚è³ª', unit: 'g', target: currentTargets.fat, current: currentLogData.F, color: 'red' },
                { label: 'ç‚­æ°´åŒ–ç‰©', unit: 'g', target: currentTargets.carbs, current: currentLogData.C, color: 'yellow' },
                { label: 'å®Ÿè³ªKcal', unit: 'kcal', target: netKcalTarget, current: currentLogData.Kcal, color: 'green' }
            ];

            stats.forEach(stat => {
                const element = document.createElement('div');
                element.className = 'p-3 bg-gray-50 rounded-lg';
                element.innerHTML = `
                    <p class="text-xs font-medium text-gray-500">${stat.label}</p>
                    <p class="text-xl font-extrabold text-${stat.color}-600">${formatKcal(stat.current)}</p>
                    <p class="text-sm text-gray-500">ç›®æ¨™: ${formatKcal(stat.target)}</p>
                `;
                targetSummary.appendChild(element);
            });
        }

        function renderPFCVisualization() {
            pfcVisualization.innerHTML = '';
            
            const baseKcalTarget = currentTargets.kcal || 2500;
            const netKcalTarget = baseKcalTarget + currentLogData.exerciseKcal;

            const stats = [
                { label: 'ã‚¿ãƒ³ãƒ‘ã‚¯è³ª (P)', target: currentTargets.protein, current: currentLogData.P, color: 'blue' },
                { label: 'è„‚è³ª (F)', target: currentTargets.fat, current: currentLogData.F, color: 'red' },
                { label: 'ç‚­æ°´åŒ–ç‰© (C)', target: currentTargets.carbs, current: currentLogData.C, color: 'yellow' },
                { label: `ãƒãƒƒãƒˆã‚«ãƒ­ãƒªãƒ¼ (ç›®æ¨™:${formatKcal(netKcalTarget)} / æ¶ˆè²»:${formatKcal(currentLogData.exerciseKcal)})`, target: netKcalTarget, current: currentLogData.Kcal, color: 'green' }
            ];

            stats.forEach(stat => {
                const percentage = stat.current / stat.target;
                const progressWidth = Math.min(percentage * 100, 100);
                const isOver = percentage > 1;
                const statusColor = isOver ? 'bg-purple-500' : `bg-${stat.color}-500`;
                const textColor = isOver ? 'text-purple-700' : `text-${stat.color}-700`;
                const labelColor = isOver ? 'text-purple-600 font-bold' : 'text-gray-700';
                
                pfcVisualization.innerHTML += `
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="${labelColor} text-sm">${stat.label}</span>
                            <span class="${textColor} text-sm font-semibold">${formatKcal(stat.current)} / ${formatKcal(stat.target)} ${stat.current > stat.target ? '(OVER)' : ''}</span>
                        </div>
                        <div class="w-full h-3 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full ${statusColor} rounded-full pfc-indicator" style="width: ${progressWidth}%;"></div>
                        </div>
                    </div>
                `;
            });
        }
        
        // --- Initialization ---
        // Firebaseèªè¨¼ã¯ä¸è¦ã«ãªã£ãŸãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã®ãƒ­ãƒ¼ãƒ‰ã‚’å®Ÿè¡Œ
        loadTargetsAndLogsFromLocal();

    </script>
</body>
</html>
